name: Rebuild Feed and Deploy
on:
  schedule:
    - cron: '*/15 * * * *'  # every 15 minutes
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: |
          npm install
          npm install -D tsx typescript

      - name: Rebuild feed
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DISABLE_SUMMARIES: ${{ secrets.DISABLE_SUMMARIES }}
          RSS_USER_AGENT: ${{ secrets.RSS_USER_AGENT }}
        run: |
          npx tsx scripts/rebuild.ts
          test -f public/data/feed.json || (echo "ERROR: public/data/feed.json missing" && exit 1)
          node -e "const j=require('fs').readFileSync('public/data/feed.json','utf8');JSON.parse(j);console.log('feed.json OK');"

      - name: Prepare static export (Pages mode)
        env:
          NEXT_PUBLIC_IS_PAGES: '1'
          NEXT_TELEMETRY_DISABLED: '1'
        run: npm run build

      - name: Ensure feed in export + health markers
        run: |
          mkdir -p out/data
          cp -f public/data/feed.json out/data/feed.json
          date -u +%s > out/data/health.txt
          echo "ok" > out/health.txt

      - name: Create .nojekyll
        run: |
          mkdir -p out
          touch out/.nojekyll

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
          publish_branch: gh-pages
